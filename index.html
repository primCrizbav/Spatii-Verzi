<!DOCTYPE html>
<html>
<head>
    <title>Spatii Verzi - Crizbav</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }
        .legend { 
            background: white; 
            padding: 15px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 280px;
        }
        .legend h4 { 
            margin: 0 0 15px 0; 
            color: #2c5f2d; 
            font-size: 18px;
            text-align: center;
        }
        .legend-item { 
            display: flex; 
            align-items: center; 
            margin: 8px 0; 
            font-size: 14px;
        }
        .legend-item input { margin-right: 8px; }
        .color-box { 
            width: 20px; 
            height: 15px; 
            margin-right: 8px; 
            border: 1px solid #666;
            border-radius: 3px;
        }
        .popup-content {
            font-family: Arial, sans-serif;
            max-width: 250px;
        }
        .popup-content h4 {
            margin: 0 0 10px 0;
            color: #2c5f2d;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
        }
        .popup-content table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .popup-content td {
            padding: 4px 6px;
            border-bottom: 1px solid #eee;
        }
        .popup-content td:first-child {
            font-weight: bold;
            background-color: #f9f9f9;
            width: 40%;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geometryutil/0.10.1/leaflet.geometryutil.min.js"></script>
    <script>
        // Initialize map centered on Crizbav area (disable location detection)
        var map = L.map('map', {
            center: [46.7712, 23.6236],
            zoom: 15,
            zoomControl: true,
            attributionControl: true
        });

        // Define multiple base layers
        var baseLayers = {
            "Satellite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri, Maxar, Earthstar Geographics, and the GIS User Community'
            }),
            "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }),
            "Hybrid": L.layerGroup([
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: '© Esri, Maxar, Earthstar Geographics, and the GIS User Community'
                }),
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
                    attribution: ''
                })
            ])
        };

        // Add default satellite layer
        baseLayers["Satellite"].addTo(map);

        // Layer groups for organization
        var layerGroups = {};

        // Function to safely get property value with multiple possible field names
        function getProperty(properties, fieldNames) {
            for (var i = 0; i < fieldNames.length; i++) {
                if (properties[fieldNames[i]] !== undefined && properties[fieldNames[i]] !== null && properties[fieldNames[i]] !== '') {
                    return properties[fieldNames[i]];
                }
            }
            return 'N/A';
        }

        // Function to create popup content based on layer type
        function createPopupContent(properties, layerName) {
            var content = '<div class="popup-content">';
            content += '<h4>' + layerName + '</h4>';
            
            // Debug: show all available fields for SVD Aliniament
            if (layerName === 'SVD Aliniament') {
                console.log('SVD Aliniament properties:', properties);
                console.log('Available field names:', Object.keys(properties));
            }
            
            content += '<table>';

            switch(layerName) {
                case 'Copaci':
                    content += '<tr><td>ID:</td><td>' + getProperty(properties, ['Nr.Identi', 'NrIdentifi', 'ID', 'id']) + '</td></tr>';
                    content += '<tr><td>Specie:</td><td>' + getProperty(properties, ['Specie', 'specie', 'Species']) + '</td></tr>';
                    content += '<tr><td>Diametru trunchi:</td><td>' + getProperty(properties, ['Diametru t', 'Diametru_t', 'Diametru', 'diametru']) + ' cm</td></tr>';
                    content += '<tr><td>Înălțime:</td><td>' + getProperty(properties, ['Inaltime (', 'Inaltime', 'Height', 'height']) + ' m</td></tr>';
                    content += '<tr><td>Starea:</td><td>' + getProperty(properties, ['Evaluarea', 'Starea', 'Status', 'status']) + '</td></tr>';
                    break;
                
                case 'Zone Specializate':
                    content += '<tr><td>ID:</td><td>' + getProperty(properties, ['Nr.Identifi', 'NrIdentifi', 'ID', 'id']) + '</td></tr>';
                    content += '<tr><td>Destinație:</td><td>' + getProperty(properties, ['Destinatie', 'Destinație', 'destinatie']) + '</td></tr>';
                    content += '<tr><td>Categorie:</td><td>' + getProperty(properties, ['Cat/Colonia', 'CatFolosin', 'Cat_Colonia', 'categoria']) + '</td></tr>';
                    content += '<tr><td>Suprafață:</td><td>' + getProperty(properties, ['Suprafata', 'Suprafata (mp)', 'suprafata']) + ' mp</td></tr>';
                    content += '<tr><td>Administrare:</td><td>' + getProperty(properties, ['Mod.Admin', 'ModAdmin', 'Mod_Admin', 'administrare']) + '</td></tr>';
                    content += '<tr><td>Proprietate:</td><td>' + getProperty(properties, ['Tip.Proprie', 'TipProprie', 'Tip_Proprie', 'proprietate']) + '</td></tr>';
                    break;

                case 'SVD Aliniament':
                    // Show all fields for debugging
                    var allFields = Object.keys(properties);
                    allFields.forEach(function(field) {
                        if (properties[field] !== null && properties[field] !== '') {
                            var label = field;
                            if (field.toLowerCase().includes('ident') || field.toLowerCase().includes('id')) label = 'ID';
                            else if (field.toLowerCase().includes('dest')) label = 'Destinație';
                            else if (field.toLowerCase().includes('cat') || field.toLowerCase().includes('folosin')) label = 'Categorie';
                            else if (field.toLowerCase().includes('supraf')) label = 'Suprafață';
                            else if (field.toLowerCase().includes('admin')) label = 'Administrare';
                            else if (field.toLowerCase().includes('propri')) label = 'Proprietate';
                            
                            content += '<tr><td>' + label + ':</td><td>' + properties[field] + '</td></tr>';
                        }
                    });
                    break;

                default:
                    // For all other layers, show the standard fields with correct names
                    var id = getProperty(properties, ['NrIdentifi', 'Nr.Identifi', 'ID', 'id']);
                    if (id !== 'N/A') {
                        content += '<tr><td>ID:</td><td>' + id + '</td></tr>';
                    }
                    
                    var destinatie = getProperty(properties, ['Destinatie', 'Destinație', 'destinatie']);
                    if (destinatie !== 'N/A') {
                        content += '<tr><td>Destinație:</td><td>' + destinatie + '</td></tr>';
                    }
                    
                    var categoria = getProperty(properties, ['CatFolosin', 'Cat/Colonia', 'Categoria de folosinta', 'categoria']);
                    if (categoria !== 'N/A') {
                        content += '<tr><td>Categorie:</td><td>' + categoria + '</td></tr>';
                    }
                    
                    var suprafata = getProperty(properties, ['Suprafata', 'Suprafata (mp)', 'suprafata']);
                    if (suprafata !== 'N/A') {
                        content += '<tr><td>Suprafață:</td><td>' + suprafata + ' mp</td></tr>';
                    }
                    
                    var proprietate = getProperty(properties, ['TipProprie', 'Tip.Proprie', 'Tip_Proprie', 'proprietate']);
                    if (proprietate !== 'N/A') {
                        content += '<tr><td>Proprietate:</td><td>' + proprietate + '</td></tr>';
                    }
                    
                    var administrare = getProperty(properties, ['ModAdmin', 'Mod.Admin', 'Mod_Admin', 'administrare']);
                    if (administrare !== 'N/A') {
                        content += '<tr><td>Administrare:</td><td>' + administrare + '</td></tr>';
                    }
                    break;
            }

            content += '</table></div>';
            return content;
        }

        // Layer configurations
        var layerConfigs = [
            {
                url: 'data/copaci.geojson',
                name: 'Copaci',
                color: '#228B22',
                fillColor: '#32CD32',
                weight: 2,
                fillOpacity: 0.7
            },
            {
                url: 'data/aliniament_infrastructura.geojson',
                name: 'Aliniament Infrastructura',
                color: '#0066cc',
                weight: 3,
                fillOpacity: 0.6
            },
            {
                url: 'data/svd_aliniament_infrastructura.geojson',
                name: 'SVD Aliniament',
                color: '#ff6600',
                weight: 3,
                fillOpacity: 0.6
            },
            {
                url: 'data/cimitir.geojson',
                name: 'Cimitir',
                color: '#666666',
                fillColor: '#999999',
                weight: 2,
                fillOpacity: 0.5
            },
            {
                url: 'data/zone_verzi_vegetatie_spontana.geojson',
                name: 'Vegetație Spontană',
                color: '#98FB98',
                fillColor: '#98FB98',
                weight: 1,
                fillOpacity: 0.6
            },
            {
                url: 'data/zone_verzi_specializate.geojson',
                name: 'Zone Specializate',
                color: '#32CD32',
                fillColor: '#90EE90',
                weight: 2,
                fillOpacity: 0.7
            },
            {
                url: 'data/parcuri_gradini.geojson',
                name: 'Parcuri & Grădini',
                color: '#006400',
                fillColor: '#90EE90',
                weight: 2,
                fillOpacity: 0.8
            }
        ];

        // Load all layers
        layerConfigs.forEach(function(config) {
            fetch(config.url)
                .then(response => response.json())
                .then(data => {
                    var layer = L.geoJSON(data, {
                        style: {
                            color: config.color,
                            fillColor: config.fillColor || config.color,
                            weight: config.weight,
                            fillOpacity: config.fillOpacity,
                            opacity: 0.8
                        },
                        onEachFeature: function(feature, layer) {
                            var popupContent = createPopupContent(feature.properties, config.name);
                            layer.bindPopup(popupContent);
                            
                            // Add hover effects
                            layer.on('mouseover', function() {
                                layer.setStyle({
                                    weight: config.weight + 1,
                                    fillOpacity: Math.min(config.fillOpacity + 0.2, 1)
                                });
                            });
                            
                            layer.on('mouseout', function() {
                                layer.setStyle({
                                    weight: config.weight,
                                    fillOpacity: config.fillOpacity
                                });
                            });
                        }
                    });
                    
                    layerGroups[config.name] = layer;
                    layer.addTo(map);
                })
                .catch(error => {
                    console.error('Error loading ' + config.name + ':', error);
                });
        });

        // Create legend and layer control
        var legend = L.control({position: 'topright'});
        legend.onAdd = function(map) {
            var div = L.DomUtil.create('div', 'legend');
            div.innerHTML = '<h4>Spații Verzi</h4>';
            
            layerConfigs.forEach(function(config) {
                div.innerHTML += 
                    '<div class="legend-item">' +
                    '<input type="checkbox" id="' + config.name.replace(/\s+/g, '') + '" checked onchange="toggleLayer(\'' + config.name + '\')">' +
                    '<div class="color-box" style="background-color: ' + (config.fillColor || config.color) + ';"></div>' +
                    '<label for="' + config.name.replace(/\s+/g, '') + '">' + config.name + '</label>' +
                    '</div>';
            });
            
            return div;
        };
        legend.addTo(map);

        // Add search control
        var searchControl = L.control({position: 'topleft'});
        searchControl.onAdd = function(map) {
            var div = L.DomUtil.create('div', 'search-control');
            div.style.background = 'white';
            div.style.padding = '5px';
            div.style.borderRadius = '5px';
            div.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
            div.style.marginTop = '10px';
            div.innerHTML = '<input type="text" id="searchInput" placeholder="Căutare ID sau destinație..." style="padding: 5px; width: 200px; border: 1px solid #ccc; border-radius: 3px;">';
            
            // Prevent map interaction when using search
            L.DomEvent.disableClickPropagation(div);
            
            return div;
        };
        searchControl.addTo(map);

        // Add measurement tools
        var measureControl = L.control({position: 'topleft'});
        measureControl.onAdd = function(map) {
            var div = L.DomUtil.create('div', 'measure-control');
            div.style.background = 'white';
            div.style.padding = '5px';
            div.style.borderRadius = '5px';
            div.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
            div.style.marginTop = '10px';
            div.innerHTML = 
                '<button id="measureDistance" style="margin: 2px; padding: 5px; border: 1px solid #ccc; border-radius: 3px; background: white; cursor: pointer;">📏 Distanță</button><br>' +
                '<button id="measureArea" style="margin: 2px; padding: 5px; border: 1px solid #ccc; border-radius: 3px; background: white; cursor: pointer;">📐 Suprafață</button><br>' +
                '<button id="clearMeasurements" style="margin: 2px; padding: 5px; border: 1px solid #ccc; border-radius: 3px; background: white; cursor: pointer;">🗑️ Șterge</button>';
            
            // Prevent map interaction when using tools
            L.DomEvent.disableClickPropagation(div);
            
            return div;
        };
        measureControl.addTo(map);

        // Measurement variables
        var measurementLayer = L.layerGroup().addTo(map);
        var isDistanceMeasuring = false;
        var isAreaMeasuring = false;
        var measurePoints = [];
        var currentLine = null;
        var currentPolygon = null;

        // Toggle layer function
        function toggleLayer(layerName) {
            var layer = layerGroups[layerName];
            if (layer) {
                if (map.hasLayer(layer)) {
                    map.removeLayer(layer);
                } else {
                    map.addLayer(layer);
                }
            }
        }

        // Add scale
        L.control.scale({
            position: 'bottomleft',
            metric: true,
            imperial: false
        }).addTo(map);

        // Fit map to data bounds when all layers load (with proper centering)
        setTimeout(function() {
            var group = new L.featureGroup(Object.values(layerGroups));
            if (group.getLayers().length > 0) {
                // Fit to bounds with some padding, but ensure minimum zoom level
                var bounds = group.getBounds();
                map.fitBounds(bounds, {
                    padding: [20, 20],
                    maxZoom: 16  // Don't zoom in too much
                });
            } else {
                // Fallback: ensure map stays centered on Crizbav even if data doesn't load
                map.setView([46.7712, 23.6236], 15);
            }
        }, 3000);
    </script>
</body>
</html>